首先实现牌堆和手牌功能：
- 有卡组，弃牌堆，牌堆和手牌
- 卡组是局外的牌组，其他三个是局内的
- 卡组需要支持添加和删除牌
- 局内逻辑：
    - 牌堆为随机排布的卡组
    - 默认每回合开始时从牌堆按顺序抽取一定数量牌到手牌
    - 手牌使用后进入弃牌堆
    - 牌堆为空时重新随机将卡组洗入，清空弃牌堆

卡是任意一个prefab，这个功能系统会被用到很多不同的游戏中，因此做好适配性

一 基本设定
波是一个类似数组的结构
一条波由若干个最小单位组成 最小单位叫作波峰
波峰可以位于波的任意位置，波中可以有空位
每个波峰有以下属性
· 位置 position
· 强度 value 为整数 可正可负 表示数值大小 正负只表示数值符号 不表示方向
· 攻击方向 attackDirection 取值为 左向 或 右向 用于表示是谁发出的攻击

这里的波只是一个抽象数值模型 不需要遵守真实物理规律

二 计算粒度
所有判定都在最小单位层面进行
也就是说 碰撞时是一个一个波峰去配对和抵消 而不是作为一整条波计算
调用配对函数后以波峰为单位做运算，调用的两个波相同位置的波峰同时进行配对

三 配对规则
这部分功能会被其它地方调用，考虑单独封装。
- 两个波中有相同位置的波峰同时进行配对
- 两个波峰强度分别为 a 和 b，攻击方向分别为 aDirection 和 bDirection
  - 将a和b的强度相加得到结果波峰的强度
    - 也就是说正负波会相互抵消而同号波会相互叠加
  - 如果攻击方向相反，攻击方向继承数值绝对值更大的那个波峰的攻击方向
- 计算结束后按照攻击方向，保留波峰原位置合并波峰生成一或二个新波

四 额外需求
留出数值访问接口，未来需要实现游戏内波的UI显示，需要访问波峰的数据


设计合适的数据结构 完成以上需求
不需要进行碰撞检测，未来会有单独的部分来调用配对逻辑


波牌=包含波数据的实例

手牌波合成+发出
 - 设置手牌波，初始为空
 - 每次当波牌从手牌堆中被摆放（此处如何触发是否摆放的功能后续会实现，只要实现功能函数，测试里直接调用即可），波牌的波与手牌波配对，生成的新波作为手牌波
 - 波牌未来会根据摆放位置决定最尾端的波峰位置（未来会实现，现在的测试里仅将两个波牌的最尾端波峰位置设置到不同的位置即可）
波牌撤回手牌堆=相同位置配对负波（同样不要考虑触发，有功能函数实现即可，测试里直接调用）

发出的波是一个新波，使合成波的最首个波峰对齐0号位

完成以上需求并给出相应测试


手牌波合成
一个列表，每个element储存多个手牌波数据
列表位置和生成波的波峰位置对应

确认功能：
1. 格表大小是随设定的手牌波大小动态调整的，slot作为prefab被动态生成
2. 每个格子也可以存储多个波牌，不影响波牌的效果和波的配对
2. 不需要额外测试，但每次手牌波合成时都返回手牌波状态来作为测试
3. 波牌component现在无法设置波数据

现在联动两个系统，手牌堆里的卡牌（包含波牌和未来的其他牌种）可以被拖动
  - 卡牌可以在手牌堆和格表之间拖动
  - 自动吸附对应格子
  - 手牌堆现在可能也需要slot来实现这一点
- 在手牌堆的牌标记为手牌，格表的标记为待使用


事件系统
- 独立开始结束回合等事件
  -开始
    -initialize
    -抽牌
    -待添加
  -结束
    -弃牌
    -发波
    -待添加


一、
波系统可以输出一个“有序波峰伤害列表” hitSequence
使用每个波峰确定每个元素称为 PeakHit， 包含：
根据攻击方向确定 target 目标实体（这里只有玩家和敌人两个单位）
使用强度绝对值确定 damage 该波峰对目标造成的伤害值
使用波峰位置确定 orderIndex 序号 或时间顺序 用来保证播放先后


二 生命组件 HealthComponent

请为所有有生命的单位 （这里只有玩家和敌人两个单位） 设计一个统一的生命组件 HealthComponent

功能需求

处理：
 - 回血
 - 死亡
 - 扣血
 - 护盾（独立于血量计算的值）

三 伤害结算系统 DamageSystem

请实现一个独立的 DamageSystem 用来处理波系统输出的有序波峰伤害列表


有序列表 HitSequence
List<PeakHit> hitSequence
列表在进入 DamageSystem 前已经按 orderIndex 排好序

2 核心流程

逻辑要求

1 hits 已经按 orderIndex 升序
2 遍历 hits 时 逐个依次命中结算
3 对于每个 PeakHit
· 通过 target 确定对象和其 HealthComponent（这里只有玩家和敌人两个单位）
· 若目标不存在 或已经死亡 跳过
· 调用目标扣血函数
· 若目标在这次伤害后死亡 需要立刻更新死亡状态


3 多单位通用
DamageSystem 不区分玩家或敌人
只通过 target 和组件系统找到目标
玩家和敌人都只是“挂了 HealthComponent 的实体”

四 表现与逻辑配合

请在设计中预留接口 使表现层可以按波峰顺序播放扣血动画（动画部分暂不完成）

所有设计都要围绕“有序波峰伤害列表 逐个结算”的前提实现


我要你帮我设计一个类似《杀戮尖塔 Slay the Spire》的随机地图系统，实现思路清晰但不需要写出完整代码。请按下面要求来思考和说明。

一 地图整体结构（拓扑）
1 把整张地图视为一个从下到上的“爬塔”结构：
玩家从底部起点出发，每层向上移动一格，最终到达顶端 boss。
2 地图在内部用“有向无环图 DAG”建模：

按行分层，每一行代表一层楼

同一层有多个节点（房间）

只允许从第 i 层节点连接到第 i+1 层的节点，不允许回退和横向循环
3 请设计一个“层级网格”的概念：

高度 H（层数）和宽度 W（每层最多节点数）

不要求所有格子都有节点，但每层要有若干有效节点
4 输出结果中，每个节点至少包含：

所在层数和列位置

邻接的上层节点列表（可以通往哪里）

节点类型（战斗、精英、营火、商店、问号等）之后再填

二 路线生成思路
1 核心目标：保证从起点到 boss 有多条可选路径，并让路径之间有一定交叉和汇合，避免过于线性或过于杂乱。
2 请说明一个自下而上的路径生成策略，例如：

先在最底层生成若干起点节点

然后逐层向上，为每个节点在上一层随机连接 1～3 个“邻近列”的节点

控制整体的“分支”和“汇合”，比如：
· 避免出现太多平行、互不交叉的独立路线
· 同一层的节点数量保持在一个合理区间
3 请设计一些约束来避免“死图”：

从任何一个起点至少有一条路径可以到 boss

不要出现完全孤立的节点（无法从前一层到达，或者无法通往更上一层）

可以用一次 BFS/DFS 或简单检查保证连通性，不符合就重生成或微调

三 节点内容分配（战斗/营火/精英/商店/事件）
1 在拓扑生成完成后，再为各节点分配“内容类型”。
2 请给出一套“全局配比 + 层级权重”的思路，而不是简单均匀随机：

全图中普通战斗、精英、营火、商店、事件的目标数量区间

每个层级类型的权重分布（例如前几层几乎不出现精英，中后期精英概率增加，营火分布更均匀）
3 请加入“路径合理性约束”，比如：

任意一条从起点到 boss 的路径上，营火节点数量不少于某个下限，避免一路无休整

相邻几层不能出现过多连续精英，避免难度 spike 过高

重要功能点（商店、营火）不要全挤在前期或后期
4 请说明如何在分配类型时交替使用：

先按权重随机赋值

再扫描若干条随机路径做统计

若不满足设计的节奏约束，则对节点类型进行局部调整或者整图重 roll

四 难度与章节参数化
1 请设计参数化思路，使不同章节 / 不同难度可以复用同一套生成逻辑：

如 H、W、精英比例、营火下限、商店上限、事件比例等都由配置控制

高难度可以提升精英密度、减少营火、增加问号的不确定性
2 请说明如何通过修改参数，而不是改核心算法，来得到：

新章节地图

特殊模式（例如精英密集层、事件密集层）

五 表现与交互层抽象
1 说明逻辑层和表现层的分离：

逻辑层只关心节点 ID、层数、类型和连边关系

表现层可以把这些节点布局成类似杀戮尖塔的地图 UI（节点图标 + 曲线连线）
2 请设计简单的数据结构，方便前端直接渲染：

节点数组

边数组（从节点 A 到节点 B）

玩家当前所在节点 ID，可选节点列表

六 输出形式要求
在回答中：
1 不需要写具体语言的代码实现，但要给出清晰的算法步骤，例如：

“先建一个 H×W 的虚拟网格，再按层多次随机生成路径”

“用全局配比 + 本地约束的方式分配节点类型”
2 对每一步说明其设计目的：

为什么要先生成拓扑再填类型

这些约束如何让地图既随机又“看起来合理、玩起来有节奏”
3 可选：可以给出一些简单伪代码片段，用来帮助理解流程，但不要变成完整工程实现

总体目标是：
复现杀戮尖塔那种“从下到上、分支交错、每局都不同、但节奏和难度大致合理”的随机地图系统设计思路，让我拿到你的方案后，可以自己用任意语言实现。
所以整体是可行的，只是“路线规划型乐趣”会弱一些，“在信息不完全下做权衡”的乐趣会强一些，看你游戏定位。


波显示 
这个功能会被用在玩家和敌人波，是通用功能
只负责获取波数据和container，使用波峰位置和强度值在container里显示波形

波是曲线（指的是上下起伏的波，波峰等看以下要求） 
  正值波峰向上，负值向下 
  值越大波峰越高，线性关系 
  


小队成员系统
 - 单独管理小队成员实例
   - 开始战斗时生成小队数据里的成员
   - 小队数据（有哪些成员的数据）支持战斗外更改
     - 成员删除/添加
     - 不处理成员的具体参数和能力
  - 成员数据表单独管理，采用和节点种类管理类似的方法
   - 参数：
     - 无血量，实质上是道具
     - 每次战斗所花费的雇佣金（每次战斗扣除金币）
     - 能力（你来考虑如何实现设置）
       - 与其他几乎所有系统交互
       - 融合进伤害系统
         - 直伤
         - 回血
       - 特殊状态
         - 。。。
      - Prefab


角色特殊状态（通用）
  - 敌人和玩家通用
    - 受到伤害减少
    - 攻击伤害减少
    - 受到伤害增加
    - 攻击伤害增加
  - 为每个状态加入一下参数
    - 名称（tag方便以后UI显示）
    - 持续回合数
    - 数值
  - 状态的互相影响是相互相乘，所以顺序不影响
  - 给出为角色添加状态的接口

强度同号：放入绝对值更大的方向的结果波，强度为相减绝对值
强度异号：同时放入两个结果波，强度为绝对值相加
结果波波峰位置继承匹配的两个波峰的位置
